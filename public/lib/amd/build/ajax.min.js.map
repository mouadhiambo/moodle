{"version":3,"file":"ajax.min.js","sources":["../src/ajax.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Standard Ajax wrapper for Moodle. It calls the central Ajax script,\r\n * which can call any existing webservice using the current session.\r\n * In addition, it can batch multiple requests and return multiple responses.\r\n *\r\n * @module     core/ajax\r\n * @copyright  2015 Damyon Wiese <damyon@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @since      2.9\r\n */\r\ndefine(['jquery', 'core/config', 'core/log', 'core/url'], function($, config, Log, URL) {\r\n\r\n/**\r\n * A request to be performed.\r\n *\r\n * @typedef {object} request\r\n * @property {string} methodname The remote method to be called\r\n * @property {object} args The arguments to pass when fetching the remote content\r\n */\r\n\r\n    // Keeps track of when the user leaves the page so we know not to show an error.\r\n    var unloading = false;\r\n\r\n    /**\r\n     * Success handler. Called when the ajax call succeeds. Checks each response and\r\n     * resolves or rejects the deferred from that request.\r\n     *\r\n     * @method requestSuccess\r\n     * @private\r\n     * @param {Object[]} responses Array of responses containing error, exception and data attributes.\r\n     */\r\n    var requestSuccess = function(responses) {\r\n        // Call each of the success handlers.\r\n        var requests = this,\r\n            exception = null,\r\n            i = 0,\r\n            request,\r\n            response,\r\n            nosessionupdate;\r\n\r\n        if (responses.error) {\r\n            // There was an error with the request as a whole.\r\n            // We need to reject each promise.\r\n            // Unfortunately this may lead to duplicate dialogues, but each Promise must be rejected.\r\n            for (; i < requests.length; i++) {\r\n                request = requests[i];\r\n                request.deferred.reject(responses);\r\n            }\r\n\r\n            return;\r\n        }\r\n\r\n        for (i = 0; i < requests.length; i++) {\r\n            request = requests[i];\r\n\r\n            response = responses[i];\r\n            // We may not have responses for all the requests.\r\n            if (typeof response !== \"undefined\") {\r\n                if (response.error === false) {\r\n                    // Call the done handler if it was provided.\r\n                    request.deferred.resolve(response.data);\r\n                } else {\r\n                    exception = response.exception;\r\n                    nosessionupdate = requests[i].nosessionupdate;\r\n                    break;\r\n                }\r\n            } else {\r\n                // This is not an expected case.\r\n                exception = new Error('missing response');\r\n                break;\r\n            }\r\n        }\r\n        // Something failed, reject the remaining promises.\r\n        if (exception !== null) {\r\n            // Redirect to the login page.\r\n            if (exception.errorcode === \"servicerequireslogin\" && !nosessionupdate) {\r\n                window.location = URL.relativeUrl(\"/login/index.php\");\r\n            } else {\r\n                requests.forEach(function(request) {\r\n                    request.deferred.reject(exception);\r\n                });\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Fail handler. Called when the ajax call fails. Rejects all deferreds.\r\n     *\r\n     * @method requestFail\r\n     * @private\r\n     * @param {jqXHR} jqXHR The ajax object.\r\n     * @param {string} textStatus The status string.\r\n     * @param {Error|Object} exception The error thrown.\r\n     */\r\n    var requestFail = function(jqXHR, textStatus, exception) {\r\n        // Reject all the promises.\r\n        var requests = this;\r\n\r\n        var i = 0;\r\n        for (i = 0; i < requests.length; i++) {\r\n            var request = requests[i];\r\n\r\n            if (unloading) {\r\n                // No need to trigger an error because we are already navigating.\r\n                Log.error(\"Page unloaded.\");\r\n                Log.error(exception);\r\n            } else {\r\n                request.deferred.reject(exception);\r\n            }\r\n        }\r\n    };\r\n\r\n    return /** @alias module:core/ajax */ {\r\n        // Public variables and functions.\r\n        /**\r\n         * Make a series of ajax requests and return all the responses.\r\n         *\r\n         * @method call\r\n         * @param {request[]} requests Array of requests with each containing methodname and args properties.\r\n         *                   done and fail callbacks can be set for each element in the array, or the\r\n         *                   can be attached to the promises returned by this function.\r\n         * @param {Boolean} [async=true] If false this function will not return until the promises are resolved.\r\n         * @param {Boolean} [loginrequired=true] When false this function calls an endpoint which does not use the\r\n         *                  session.\r\n         *                  Note: This may only be used with external functions which have been marked as\r\n         *                  `'loginrequired' => false`\r\n         * @param {Boolean} [nosessionupdate=false] If true, the timemodified for the session will not be updated.\r\n         * @param {Number}  [timeout] number of milliseconds to wait for a response. Defaults to no limit.\r\n         * @param {Number}  [cachekey] A cache key used to improve browser-side caching.\r\n         *                  Typically the same `cachekey` is used for all function calls.\r\n         *                  When the key changes, this causes the URL used to perform the fetch to change, which\r\n         *                  prevents the existing browser cache from being used.\r\n         *                  Note: This option is only availbale when `loginrequired` is `false`.\r\n         *                  See {@link https://tracker.moodle.org/browser/MDL-65794} for more information.\r\n         * @return {Promise[]} The Promises for each of the supplied requests.\r\n         *                  The order of the Promise matches the order of requests exactly.\r\n         *\r\n         * @example <caption>A simple example that you might find in a repository module</caption>\r\n         *\r\n         * import {call as fetchMany} from 'core/ajax';\r\n         *\r\n         * export const fetchMessages = timeSince => fetchMany([{methodname: 'core_message_get_messages', args: {timeSince}}])[0];\r\n         *\r\n         * export const fetchNotifications = timeSince => fetchMany([{\r\n         *     methodname: 'core_message_get_notifications',\r\n         *     args: {\r\n         *         timeSince,\r\n         *     }\r\n         * }])[0];\r\n         *\r\n         * export const fetchSomethingElse = (some, params, here) => fetchMany([{\r\n         *     methodname: 'core_get_something_else',\r\n         *     args: {\r\n         *         some,\r\n         *         params,\r\n         *         gohere: here,\r\n         *     },\r\n         * }])[0];\r\n         *\r\n         * @example <caption>An example of fetching a string using the cachekey parameter</caption>\r\n         * import {call as fetchMany} from 'core/ajax';\r\n         * import * as Notification from 'core/notification';\r\n         *\r\n         * export const performAction = (some, args) => {\r\n         *     Promises.all(fetchMany([{methodname: 'core_get_string', args: {\r\n         *         stringid: 'do_not_copy',\r\n         *         component: 'core',\r\n         *         lang: 'en',\r\n         *         stringparams: [],\r\n         *     }}], true, false, false, undefined, M.cfg.langrev))\r\n         *     .then(([doNotCopyString]) => {\r\n         *         window.console.log(doNotCopyString);\r\n         *     })\r\n         *     .catch(Notification.exception);\r\n         * };\r\n         *\r\n         */\r\n        call: function(requests, async, loginrequired, nosessionupdate, timeout, cachekey) {\r\n            $(window).bind('beforeunload', function() {\r\n                unloading = true;\r\n            });\r\n            var ajaxRequestData = [],\r\n                i,\r\n                promises = [],\r\n                methodInfo = [],\r\n                requestInfo = '';\r\n\r\n            var maxUrlLength = 2000;\r\n\r\n            if (typeof loginrequired === \"undefined\") {\r\n                loginrequired = true;\r\n            }\r\n            if (typeof async === \"undefined\") {\r\n                async = true;\r\n            }\r\n            if (typeof timeout === 'undefined') {\r\n                timeout = 0;\r\n            }\r\n            if (typeof cachekey === 'undefined') {\r\n                cachekey = null;\r\n            } else {\r\n                cachekey = parseInt(cachekey);\r\n                if (cachekey <= 0) {\r\n                    cachekey = null;\r\n                } else if (!cachekey) {\r\n                    cachekey = null;\r\n                }\r\n            }\r\n\r\n            if (typeof nosessionupdate === \"undefined\") {\r\n                nosessionupdate = false;\r\n            }\r\n            for (i = 0; i < requests.length; i++) {\r\n                var request = requests[i];\r\n                ajaxRequestData.push({\r\n                    index: i,\r\n                    methodname: request.methodname,\r\n                    args: request.args\r\n                });\r\n                request.nosessionupdate = nosessionupdate;\r\n                request.deferred = $.Deferred();\r\n                promises.push(request.deferred.promise());\r\n                // Allow setting done and fail handlers as arguments.\r\n                // This is just a shortcut for the calling code.\r\n                if (typeof request.done !== \"undefined\") {\r\n                    request.deferred.done(request.done);\r\n                }\r\n                if (typeof request.fail !== \"undefined\") {\r\n                    request.deferred.fail(request.fail);\r\n                }\r\n                request.index = i;\r\n                methodInfo.push(request.methodname);\r\n            }\r\n\r\n            if (methodInfo.length <= 5) {\r\n                requestInfo = methodInfo.sort().join();\r\n            } else {\r\n                requestInfo = methodInfo.length + '-method-calls';\r\n            }\r\n\r\n            ajaxRequestData = JSON.stringify(ajaxRequestData);\r\n            var settings = {\r\n                type: 'POST',\r\n                context: requests,\r\n                dataType: 'json',\r\n                processData: false,\r\n                async: async,\r\n                contentType: \"application/json\",\r\n                timeout: timeout\r\n            };\r\n\r\n            var script = 'service.php';\r\n            var url = config.wwwroot + '/lib/ajax/';\r\n            if (!loginrequired) {\r\n                script = 'service-nologin.php';\r\n                url += script + '?info=' + requestInfo;\r\n                if (cachekey) {\r\n                    url += '&cachekey=' + cachekey;\r\n                    settings.type = 'GET';\r\n                }\r\n            } else {\r\n                url += script + '?sesskey=' + config.sesskey + '&info=' + requestInfo;\r\n            }\r\n\r\n            if (nosessionupdate) {\r\n                url += '&nosessionupdate=true';\r\n            }\r\n\r\n            if (settings.type === 'POST') {\r\n                settings.data = ajaxRequestData;\r\n            } else {\r\n                var urlUseGet = url + '&args=' + encodeURIComponent(ajaxRequestData);\r\n\r\n                if (urlUseGet.length > maxUrlLength) {\r\n                    settings.type = 'POST';\r\n                    settings.data = ajaxRequestData;\r\n                } else {\r\n                    url = urlUseGet;\r\n                }\r\n            }\r\n\r\n            // Jquery deprecated done and fail with async=false so we need to do this 2 ways.\r\n            if (async) {\r\n                $.ajax(url, settings)\r\n                    .done(requestSuccess)\r\n                    .fail(requestFail);\r\n            } else {\r\n                settings.success = requestSuccess;\r\n                settings.error = requestFail;\r\n                $.ajax(url, settings);\r\n            }\r\n\r\n            return promises;\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","config","Log","URL","unloading","requestSuccess","responses","request","response","nosessionupdate","exception","i","error","this","length","deferred","reject","Error","resolve","data","errorcode","forEach","window","location","relativeUrl","requestFail","jqXHR","textStatus","call","requests","async","loginrequired","timeout","cachekey","bind","ajaxRequestData","promises","methodInfo","requestInfo","parseInt","push","index","methodname","args","Deferred","promise","done","fail","sort","join","JSON","stringify","settings","type","context","dataType","processData","contentType","script","url","wwwroot","sesskey","urlUseGet","encodeURIComponent","ajax","success"],"mappings":"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"}