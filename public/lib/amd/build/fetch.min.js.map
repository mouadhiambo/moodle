{"version":3,"file":"fetch.min.js","sources":["../src/fetch.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * The core/fetch module allows you to make web service requests to the Moodle API.\r\n *\r\n * @module     core/fetch\r\n * @copyright  Andrew Lyons <andrew@nicols.co.uk>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @example <caption>Perform a single GET request</caption>\r\n * import Fetch from 'core/fetch';\r\n *\r\n * const result = Fetch.performGet('mod_example', 'animals', { params: { type: 'mammal' } });\r\n *\r\n * result.then((response) => {\r\n *    // Do something with the Response object.\r\n * })\r\n * .catch((error) => {\r\n *     // Handle the error\r\n * });\r\n */\r\n\r\nimport * as Cfg from 'core/config';\r\nimport PendingPromise from './pending';\r\n\r\n/**\r\n * A wrapper around the Request, including a Promise that is resolved when the request is complete.\r\n *\r\n * @class RequestWrapper\r\n * @private\r\n */\r\nclass RequestWrapper {\r\n    /** @var {Request} */\r\n    #request = null;\r\n\r\n    /** @var {Promise} */\r\n    #promise = null;\r\n\r\n    /** @var {Function} */\r\n    #resolve = null;\r\n\r\n    /** @var {Function} */\r\n    #reject = null;\r\n\r\n    /**\r\n     * Create a new RequestWrapper.\r\n     *\r\n     * @param {Request} request The request object that is wrapped\r\n     */\r\n    constructor(request) {\r\n        this.#request = request;\r\n        this.#promise = new Promise((resolve, reject) => {\r\n            this.#resolve = resolve;\r\n            this.#reject = reject;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get the wrapped Request.\r\n     *\r\n     * @returns {Request}\r\n     * @private\r\n     */\r\n    get request() {\r\n        return this.#request;\r\n    }\r\n\r\n    /**\r\n     * Get the Promise link to this request.\r\n     *\r\n     * @return {Promise}\r\n     * @private\r\n     */\r\n    get promise() {\r\n        return this.#promise;\r\n    }\r\n\r\n    /**\r\n     * Handle the response from the request.\r\n     *\r\n     * @param {Response} response\r\n     * @private\r\n     */\r\n    handleResponse(response) {\r\n        if (response.ok) {\r\n            this.#resolve(response);\r\n        } else {\r\n            this.#reject(response.statusText);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * A class to handle requests to the Moodle REST API.\r\n *\r\n * @class Fetch\r\n */\r\nexport default class Fetch {\r\n    /**\r\n     * Make a single request to the Moodle API.\r\n     *\r\n     * @param {string} component The frankenstyle component name\r\n     * @param {string} action The component action to perform\r\n     * @param {object} params\r\n     * @param {object} [params.params = {}] The parameters to pass to the API\r\n     * @param {string|Object|FormData} [params.body = null] The HTTP method to use\r\n     * @param {string} [params.method = \"GET\"] The HTTP method to use\r\n     * @returns {Promise<Response>} A promise that resolves to the Response object for the request\r\n     */\r\n    static async request(\r\n        component,\r\n        action,\r\n        {\r\n            params = {},\r\n            body = null,\r\n            method = 'GET',\r\n        } = {},\r\n    ) {\r\n        const pending = new PendingPromise(`Requesting ${component}/${action} with ${method}`);\r\n        const requestWrapper = Fetch.#getRequest(\r\n            Fetch.#normaliseComponent(component),\r\n            action,\r\n            { params, method, body },\r\n        );\r\n        const result = await fetch(requestWrapper.request);\r\n\r\n        pending.resolve();\r\n\r\n        requestWrapper.handleResponse(result);\r\n\r\n        return requestWrapper.promise;\r\n    }\r\n\r\n    /**\r\n     * Make a request to the Moodle API.\r\n     *\r\n     * @param {string} component The frankenstyle component name\r\n     * @param {string} action The component action to perform\r\n     * @param {object} params\r\n     * @param {object} [params.params = {}] The parameters to pass to the API\r\n     * @returns {Promise<Response>} A promise that resolves to the Response object for the request\r\n     */\r\n    static performGet(\r\n        component,\r\n        action,\r\n        {\r\n            params = {},\r\n        } = {},\r\n    ) {\r\n        return this.request(\r\n            component,\r\n            action,\r\n            { params, method: 'GET' },\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Make a request to the Moodle API.\r\n     *\r\n     * @param {string} component The frankenstyle component name\r\n     * @param {string} action The component action to perform\r\n     * @param {object} params\r\n     * @param {object} [params.params = {}] The parameters to pass to the API\r\n     * @returns {Promise<Response>} A promise that resolves to the Response object for the request\r\n     */\r\n    static performHead(\r\n        component,\r\n        action,\r\n        {\r\n            params = {},\r\n        } = {},\r\n    ) {\r\n        return this.request(\r\n            component,\r\n            action,\r\n            { params, method: 'HEAD' },\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Make a request to the Moodle API.\r\n     *\r\n     * @param {string} component The frankenstyle component name\r\n     * @param {string} action The component action to perform\r\n     * @param {object} params\r\n     * @param {string|Object|FormData} params.body The HTTP method to use\r\n     * @returns {Promise<Response>} A promise that resolves to the Response object for the request\r\n     */\r\n    static performPost(\r\n        component,\r\n        action,\r\n        {\r\n            body,\r\n        } = {},\r\n    ) {\r\n        return this.request(\r\n            component,\r\n            action,\r\n            { body, method: 'POST' },\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Make a request to the Moodle API.\r\n     *\r\n     * @param {string} component The frankenstyle component name\r\n     * @param {string} action The component action to perform\r\n     * @param {object} params\r\n     * @param {string|Object|FormData} params.body The HTTP method to use\r\n     * @returns {Promise<Response>} A promise that resolves to the Response object for the request\r\n     */\r\n    static performPut(\r\n        component,\r\n        action,\r\n        {\r\n            body,\r\n        } = {},\r\n    ) {\r\n        return this.request(\r\n            component,\r\n            action,\r\n            { body, method: 'PUT' },\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Make a PATCH request to the Moodle API.\r\n     *\r\n     * @param {string} component The frankenstyle component name\r\n     * @param {string} action The component action to perform\r\n     * @param {object} params\r\n     * @param {string|Object|FormData} params.body The HTTP method to use\r\n     * @returns {Promise<Response>} A promise that resolves to the Response object for the request\r\n     */\r\n    static performPatch(\r\n        component,\r\n        action,\r\n        {\r\n            body,\r\n        } = {},\r\n    ) {\r\n        return this.request(\r\n            component,\r\n            action,\r\n            { body, method: 'PATCH' },\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Make a request to the Moodle API.\r\n     *\r\n     * @param {string} component The frankenstyle component name\r\n     * @param {string} action The component action to perform\r\n     * @param {object} params\r\n     * @param {object} [params.params = {}] The parameters to pass to the API\r\n     * @param {string|Object|FormData} [params.body = null] The HTTP method to use\r\n     * @returns {Promise<Response>} A promise that resolves to the Response object for the request\r\n     */\r\n    static performDelete(\r\n        component,\r\n        action,\r\n        {\r\n            params = {},\r\n            body = null,\r\n        } = {},\r\n    ) {\r\n        return this.request(\r\n            component,\r\n            action,\r\n            {\r\n                body,\r\n                params,\r\n                method: 'DELETE',\r\n            },\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Normalise the component name to remove the core_ prefix.\r\n     *\r\n     * @param {string} component\r\n     * @returns {string}\r\n     */\r\n    static #normaliseComponent(component) {\r\n        return component.replace(/^core_/, '');\r\n    }\r\n\r\n    /**\r\n     * Get the Request for a given API request.\r\n     *\r\n     * @param {string} component The frankenstyle component name\r\n     * @param {string} endpoint The endpoint within the componet to call\r\n     * @param {object} params\r\n     * @param {object} [params.params = {}] The parameters to pass to the API\r\n     * @param {string|Object|FormData} [params.body = null] The HTTP method to use\r\n     * @param {string} [params.method = \"GET\"] The HTTP method to use\r\n     * @returns {RequestWrapper}\r\n     */\r\n    static #getRequest(\r\n        component,\r\n        endpoint,\r\n        {\r\n            params = {},\r\n            body = null,\r\n            method = 'GET',\r\n        }\r\n    ) {\r\n        const url = new URL(`${Cfg.apibase}/rest/v2/${component}/${endpoint}`);\r\n        const options = {\r\n            method,\r\n            headers: {\r\n                'Accept': 'application/json',\r\n                'Content-Type': 'application/json',\r\n            },\r\n        };\r\n\r\n        Object.entries(params).forEach(([key, value]) => {\r\n            url.searchParams.append(key, value);\r\n        });\r\n\r\n        if (body) {\r\n            if (body instanceof FormData) {\r\n                options.body = body;\r\n            } else if (body instanceof Object) {\r\n                options.body = JSON.stringify(body);\r\n            } else {\r\n                options.body = body;\r\n            }\r\n        }\r\n\r\n        return new RequestWrapper(new Request(url, options));\r\n    }\r\n}\r\n"],"names":["RequestWrapper","constructor","request","Promise","resolve","reject","this","promise","handleResponse","response","ok","statusText","Fetch","component","action","params","body","method","pending","PendingPromise","requestWrapper","result","fetch","replace","endpoint","url","URL","Cfg","apibase","options","headers","Object","entries","forEach","_ref2","key","value","searchParams","append","FormData","JSON","stringify","Request"],"mappings":"y/EA2CMA,eAkBFC,YAAYC,qEAhBD,mEAGA,mEAGA,kEAGD,2CAQUA,6CACA,IAAIC,SAAQ,CAACC,QAASC,8CAClBD,4CACDC,YAUnBH,2CACOI,eASPC,2CACOD,eASXE,eAAeC,UACPA,SAASC,kDACKD,wDAEDA,SAASE,mBAUbC,2BAabC,UACAC,YACAC,OACIA,OAAS,GADbC,KAEIA,KAAO,KAFXC,OAGIA,OAAS,8DACT,SAEEC,QAAU,IAAIC,sCAA6BN,sBAAaC,wBAAeG,SACvEG,4CAAiBR,MAtBVA,wBAsBUA,mCACnBA,MAvBSA,gCAuBTA,MAA0BC,WAC1BC,OACA,CAAEC,OAAAA,OAAQE,OAAAA,OAAQD,KAAAA,OAEhBK,aAAeC,MAAMF,eAAelB,gBAE1CgB,QAAQd,UAERgB,eAAeZ,eAAea,QAEvBD,eAAeb,0BAatBM,UACAC,YACAC,OACIA,OAAS,2DACT,UAEGT,KAAKJ,QACRW,UACAC,OACA,CAAEC,OAAAA,OAAQE,OAAQ,2BActBJ,UACAC,YACAC,OACIA,OAAS,2DACT,UAEGT,KAAKJ,QACRW,UACAC,OACA,CAAEC,OAAAA,OAAQE,OAAQ,4BActBJ,UACAC,YACAE,KACIA,6DACA,UAEGV,KAAKJ,QACRW,UACAC,OACA,CAAEE,KAAAA,KAAMC,OAAQ,2BAcpBJ,UACAC,YACAE,KACIA,6DACA,UAEGV,KAAKJ,QACRW,UACAC,OACA,CAAEE,KAAAA,KAAMC,OAAQ,4BAcpBJ,UACAC,YACAE,KACIA,6DACA,UAEGV,KAAKJ,QACRW,UACAC,OACA,CAAEE,KAAAA,KAAMC,OAAQ,+BAepBJ,UACAC,YACAC,OACIA,OAAS,GADbC,KAEIA,KAAO,6DACP,UAEGV,KAAKJ,QACRW,UACAC,OACA,CACIE,KAAAA,KACAD,OAAAA,OACAE,OAAQ,yCAWOJ,kBAChBA,UAAUU,QAAQ,SAAU,yBAenCV,UACAW,mBACAT,OACIA,OAAS,GADbC,KAEIA,KAAO,KAFXC,OAGIA,OAAS,kBAGPQ,IAAM,IAAIC,cAAOC,IAAIC,4BAAmBf,sBAAaW,WACrDK,QAAU,CACZZ,OAAAA,OACAa,QAAS,QACK,kCACM,4BAIxBC,OAAOC,QAAQjB,QAAQkB,SAAQC,YAAEC,IAAKC,aAClCX,IAAIY,aAAaC,OAAOH,IAAKC,UAG7BpB,OACIA,gBAAgBuB,SAChBV,QAAQb,KAAOA,KAEfa,QAAQb,KADDA,gBAAgBe,OACRS,KAAKC,UAAUzB,MAEfA,MAIhB,IAAIhB,eAAe,IAAI0C,QAAQjB,IAAKI"}